<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data-Driven Shelter Demand Forecasting and Resource Optimization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>Data-Driven Shelter Demand Forecasting and Resource Optimization</h1>
            <button onclick="openAddShelterModal()"
                style="background: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px;">+
                Add New Shelter</button>
        </header>

        <!-- Add Shelter Modal -->
        <div id="addShelterModal"
            style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div
                style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;">
                <span onclick="closeAddShelterModal()"
                    style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h2>Add New Shelter</h2>
                <form id="addShelterForm">
                    <div style="margin-bottom: 15px;">
                        <label for="newShelterName">Shelter Name:</label>
                        <input type="text" id="newShelterName" required
                            style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="newShelterCity">City:</label>
                        <select id="newShelterCity" required style="width: 100%; padding: 8px; margin-top: 5px;">
                            <option value="Bangalore">Bangalore</option>
                            <option value="Ahmedabad">Ahmedabad</option>
                            <option value="Chennai">Chennai</option>
                            <option value="Kolkata">Kolkata</option>
                            <option value="Mumbai">Mumbai</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Lucknow">Lucknow</option>
                            <option value="Jaipur">Jaipur</option>
                            <option value="Pune">Pune</option>
                            <option value="Surat">Surat</option>
                            <option value="Hyderabad">Hyderabad</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="newShelterCapacity">Total Capacity:</label>
                        <input type="number" id="newShelterCapacity" required min="1"
                            style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <button type="submit"
                        style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">Add
                        Shelter</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <section class="dashboard">
            <div class="card">
                <h3>Total Shelters</h3>
                <p>{{ total_shelters }}</p>
            </div>
            <div class="card">
                <h3>Avg Occupancy Rate</h3>
                <p>{{ avg_occupancy }}%</p>
            </div>
            <div class="card">
                <h3>Total Records</h3>
                <p>{{ total_records }}</p>
            </div>
        </section>

        <!-- Map Section -->
        <section class="map-section">
            <h2>Shelter Locations</h2>
            <div id="map" style="height: 400px; width: 100%; border-radius: 8px; z-index: 1;"></div>
        </section>

        <!-- Resource Optimization Insights -->
        {% if over_utilized or under_utilized %}
        <section class="optimization-section" style="margin-top: 40px;">
            <h2>Resource Optimization Insights (Last 30 Days)</h2>

            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- Over-Utilized -->
                <div
                    style="flex: 1; min-width: 300px; background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px;">
                    <h3 style="color: #856404; margin-top: 0;">âš ï¸ Over-Utilized Shelters (>90%)</h3>
                    <p style="font-size: 0.9em; color: #856404;">Consider expanding capacity or redirecting new
                        admissions.</p>
                    {% if over_utilized %}
                    <ul style="list-style: none; padding: 0;">
                        {% for shelter in over_utilized %}
                        <li style="padding: 8px 0; border-bottom: 1px solid #ffeeba;">
                            <strong>{{ shelter.shelter_name }}</strong>: {{ shelter.occupancy_rate }}%
                            <a href="{{ url_for('shelter_detail', shelter_name=shelter.shelter_name) }}"
                                style="float: right; color: #856404;">View</a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p style="color: #28a745;">No shelters are currently over-utilized.</p>
                    {% endif %}
                </div>

                <!-- Under-Utilized -->
                <div
                    style="flex: 1; min-width: 300px; background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px;">
                    <h3 style="color: #155724; margin-top: 0;">ðŸ“‰ Under-Utilized Shelters (<50%)< /h3>
                            <p style="font-size: 0.9em; color: #155724;">Consider consolidating resources or increasing
                                outreach.</p>
                            {% if under_utilized %}
                            <ul style="list-style: none; padding: 0;">
                                {% for shelter in under_utilized %}
                                <li style="padding: 8px 0; border-bottom: 1px solid #c3e6cb;">
                                    <strong>{{ shelter.shelter_name }}</strong>: {{ shelter.occupancy_rate }}%
                                    <a href="{{ url_for('shelter_detail', shelter_name=shelter.shelter_name) }}"
                                        style="float: right; color: #155724;">View</a>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p>No shelters are significantly under-utilized.</p>
                            {% endif %}
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Managerial Analytics -->
        <section class="analytics-section" style="margin-top: 40px;">
            <h2>Managerial Analytics</h2>

            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- City-wise Occupancy Chart -->
                <div
                    style="flex: 2; min-width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <h3>City-wise Average Occupancy</h3>
                    <canvas id="cityChart"></canvas>
                </div>

                <!-- System Utilization Pie Chart -->
                <div
                    style="flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <h3>System Capacity Utilization</h3>
                    <canvas id="utilizationChart"></canvas>
                    <div style="text-align: center; margin-top: 10px;">
                        <strong>{{ system_utilization.percentage }}% Utilized</strong><br>
                        <small>{{ system_utilization.occupied }} / {{ system_utilization.capacity }} Beds
                            Occupied</small>
                    </div>
                </div>
            </div>

            <!-- Top Crowded Shelters -->
            <div
                style="margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <h3>Top 5 Most Crowded Shelters</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; text-align: left;">
                            <th style="padding: 10px; border-bottom: 2px solid #dee2e6;">Shelter Name</th>
                            <th style="padding: 10px; border-bottom: 2px solid #dee2e6;">City</th>
                            <th style="padding: 10px; border-bottom: 2px solid #dee2e6;">Occupancy %</th>
                            <th style="padding: 10px; border-bottom: 2px solid #dee2e6;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for shelter in top_crowded_shelters %}
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 10px;">{{ shelter.shelter_name }}</td>
                            <td style="padding: 10px;">{{ shelter.city }}</td>
                            <td style="padding: 10px;">
                                <span style="
                                    padding: 4px 8px; 
                                    border-radius: 4px; 
                                    background: {% if shelter.occupancy_rate > 90 %}#ffeeba{% else %}#e2e3e5{% endif %};
                                    color: {% if shelter.occupancy_rate > 90 %}#856404{% else %}#383d41{% endif %};
                                    font-weight: bold;">
                                    {{ shelter.occupancy_rate }}%
                                </span>
                            </td>
                            <td style="padding: 10px;">
                                <a href="{{ url_for('shelter_detail', shelter_name=shelter.shelter_name) }}"
                                    style="color: #3498db; text-decoration: none;">Manage</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Shelters List -->
        <section class="shelters-section">
            <h2>Shelters</h2>
            <ul class="shelter-list">
                {% for shelter in shelters_list %}
                <li><a href="{{ url_for('shelter_detail', shelter_name=shelter) }}">{{ shelter }}</a></li>
                {% endfor %}
            </ul>
        </section>

        <!-- Upload Section -->
        <section class="upload-section">
            <h2>Predict Occupancy</h2>
            <form action="/upload" method="post" enctype="multipart/form-data">
                <input type="file" name="file" accept=".csv" required>
                <button type="submit">Upload & Predict</button>
            </form>
        </section>

        <!-- Prediction Results -->
        {% if preview_data %}
        <section class="results-section">
            <h2>Prediction Results (Preview)</h2>

            {% if accuracy_report %}
            <div class="accuracy-card"
                style="background: #e8f8f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #2ecc71;">
                <h3 style="margin-top: 0; color: #27ae60;">Accuracy Report</h3>
                <p><strong>Mean Absolute Error (MAE):</strong> {{ accuracy_report.mae }} beds</p>
                <p><strong>Accuracy Score:</strong> {{ accuracy_report.accuracy_score }}%</p>
                <small>Accuracy Score is calculated as 1 - (Error / Capacity)</small>
            </div>
            {% endif %}

            <a href="{{ url_for('download_file') }}" class="download-btn">Download Full Predictions</a>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            {% for key in preview_data[0].keys() %}
                            <th>{{ key }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in preview_data %}
                        <tr>
                            {% for value in row.values() %}
                            <td>{{ value }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
        {% endif %}

    </div>

    <script>
        // Leaflet Map Implementation
        const shelterLocations = {{ shelter_locations | tojson }};
        if (shelterLocations && shelterLocations.length > 0) {
            // Center map on India (approx) or the first shelter
            const map = L.map('map').setView([20.5937, 78.9629], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            shelterLocations.forEach(shelter => {
                L.marker([shelter.lat, shelter.lon])
                    .addTo(map)
                    .bindPopup(`<b>${shelter.name}</b><br>${shelter.city}<br><a href="/shelter/${encodeURIComponent(shelter.name)}">View Details</a>`);
            });
        }

        // Add Shelter Modal Logic
        const modal = document.getElementById("addShelterModal");

        function openAddShelterModal() {
            modal.style.display = "block";
        }

        function closeAddShelterModal() {
            modal.style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        document.getElementById('addShelterForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const name = document.getElementById('newShelterName').value;
            const city = document.getElementById('newShelterCity').value;
            const capacity = document.getElementById('newShelterCapacity').value;

            try {
                const response = await fetch('/add_shelter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        shelter_name: name,
                        city: city,
                        capacity: capacity
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Shelter added successfully!');
                    closeAddShelterModal();
                    location.reload(); // Reload to show new shelter in list
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });


        // Managerial Analytics Charts
        const cityStats = {{ city_stats | tojson }};
        if (cityStats && Object.keys(cityStats).length > 0) {
            const ctxCity = document.getElementById('cityChart').getContext('2d');
            new Chart(ctxCity, {
                type: 'bar',
                data: {
                    labels: Object.keys(cityStats),
                    datasets: [{
                        label: 'Avg Occupancy Rate (%)',
                        data: Object.values(cityStats),
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        const systemUtilization = {{ system_utilization | tojson }};
        if (systemUtilization) {
            const ctxUtil = document.getElementById('utilizationChart').getContext('2d');
            new Chart(ctxUtil, {
                type: 'doughnut',
                data: {
                    labels: ['Occupied', 'Available'],
                    datasets: [{
                        data: [systemUtilization.occupied, systemUtilization.capacity - systemUtilization.occupied],
                        backgroundColor: ['#e74c3c', '#2ecc71'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>